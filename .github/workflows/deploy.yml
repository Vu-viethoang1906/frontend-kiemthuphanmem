name: CI - React Frontend Test

on:
  push:
    branches: ["*"] # Ch·∫°y test cho m·ªçi nh√°nh khi push
  pull_request:
    branches: ["*"] # Ch·∫°y test cho m·ªçi PR
  workflow_dispatch: # Cho ph√©p ch·∫°y th·ªß c√¥ng

jobs:
  test:
    name: Run React Tests inside Docker
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Install dependencies
        run: npm ci

      - name: Security Check - npm audit
        run: npm audit --audit-level=moderate  || true

      - name: Run React lint / tests
        run: |
          npm run lint || true

      - name: Check Docker versions
        run: |
          docker --version
          docker compose version || docker-compose version

      - name: Build and start React test container
        run: |
          echo "üß± Building and starting React test container..."
          docker compose -f docker-compose.test.yml up --build -d

      - name: Wait for container to start
        run: sleep 5

      - name: Run React tests
        run: |
          echo "üöÄ Running React tests..."

          docker compose -f docker-compose.test.yml run --rm react-app-test npm run test:ci

        continue-on-error: false

      - name: Show logs (debug if fail)
        if: failure()
        run: docker logs react-test || true

      - name: Clean up Docker resources
        if: always()
        run: |
          echo "üßπ Cleaning up test containers..."
          docker compose -f docker-compose.test.yml down -v || true

  # ------------------------
  # üöÄ DEPLOY TO PRODUCT (main)
  # ------------------------
  deploy_dev:
    name: Deploy to DEV Server
    runs-on: ubuntu-latest
    needs: test
    if: >
      needs.test.result == 'success' &&
      github.ref == 'refs/heads/main'

    steps:
      - name: SSH to DEV server and deploy
        uses: appleboy/ssh-action@v1.2.0
        with:
          host: ${{ secrets.SSH_HOST_DEV }}
          username: ${{ secrets.SSH_USER_DEV }}
          key: ${{ secrets.SSH_KEY_DEV }}
          port: 24700
          script: |
            cd /root/KEN_CodeGym/Half-Baked-Devs-KEN-FE


            git stash push -m "rollback backup" || true
            git tag -f deploy-backup || true  # optional: mark current commit

            git pull origin main

            cd /root/KEN_CodeGym
            docker rename react-prod react-prod-old || true
            docker-compose build react-app
            docker-compose up -d react-app

            # ki·ªÉm tra
            sleep 10
            if ! docker ps | grep -q "react-prod"; then
                echo "‚ùå Deploy FE failed! Rolling back..."
                docker rm -f react-prod || true
                docker rename react-prod-old react-prod || true
                docker start react-prod || true
                # rollback code
                cd /root/KEN_CodeGym/Half-Baked-Devs-KEN-FE
                git reset --hard deploy-backup
                exit 1
            else
                echo "‚úÖ Deploy FE succeeded!"
                docker rm -freact-prod-old || true
            fi
      - name: Send Slack notification (success)
        if: success()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "üîß *DEV Frontend Deploy Successful!*\nBranch: `${{ github.ref_name }}`\nCommit: `${{ github.sha }}`"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.ULR_SLACK }}

      - name: Send Slack notification (failure)
        if: failure()
        uses: slackapi/slack-github-action@v1.26.0
        with:
          payload: |
            {
              "text": "‚ùå *DEV Frontend Deploy FAILED!*\nBranch: `${{ github.ref_name }}`\nCommit: `${{ github.sha }}`"
            }
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.ULR_SLACK }}
